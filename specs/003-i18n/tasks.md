# Implementation Tasks: 国际化支持 (i18n)

**Feature**: 003-i18n
**Date**: 2025-11-24
**Status**: ✅ Completed
**Based on**: [plan.md](./plan.md)

## 任务概述

本文档将 i18n 功能分解为可执行的开发任务，每个任务都有明确的目标、验收标准和预估工时。

## 任务优先级说明

- **P0**: 关键任务，必须首先完成
- **P1**: 高优先级，核心功能
- **P2**: 中优先级，增强功能
- **P3**: 低优先级，优化和扩展

---

## 第一阶段：基础设施搭建（2-3天）

### Task 1.1: 创建 i18n 目录结构和类型定义 [P0]

**预估工时**: 0.5 小时 | **依赖**: 无

**任务清单**:
- [x] 创建 `src/i18n/` 目录和子目录
- [x] 创建 `src/i18n/types.ts` 定义 `Locale`、`LocaleConfig`、`SUPPORTED_LOCALES`、`DEFAULT_LOCALE`

**验收标准**: TypeScript 编译无错误，类型定义符合规范

---

### Task 1.2: 实现语言检测工具 [P0]

**预估工时**: 1.5 小时 | **依赖**: Task 1.1

**任务清单**:
- [x] 创建 `src/i18n/detectLanguage.ts`
- [x] 实现 `detectBrowserLanguage()` - 检测浏览器语言，中文返回 zh-CN，其他返回 en-US
- [x] 实现 `initializeLanguage()` - 优先 LocalStorage，回退到浏览器检测
- [x] 编写单元测试（覆盖率 > 90%）

**验收标准**: 正确检测中英文，其他语言回退英文，LocalStorage 优先级正确

---

### Task 1.3: 创建 i18n Store [P0]

**预估工时**: 1.5 小时 | **依赖**: Task 1.2

**任务清单**:
- [x] 创建 `src/store/i18nStore.ts`
- [x] 使用 Zustand + persist 中间件实现状态管理
- [x] 实现 `currentLocale`、`setLocale()`、`toggleLocale()`
- [x] 编写单元测试（覆盖率 > 90%）

**验收标准**: Store 正确初始化，切换语言正常，自动持久化到 LocalStorage

---

### Task 1.4: 创建 I18nContext 和 Hook [P0]

**预估工时**: 2 小时 | **依赖**: Task 1.3

**任务清单**:
- [x] 创建 `src/i18n/I18nContext.tsx`
- [x] 实现 `I18nProvider` 组件和 `useTranslation()` Hook
- [x] 实现翻译函数 `t(key)` - 点号分隔键查找，缺失时返回键名

**验收标准**: Provider 正确订阅 Store，翻译函数正确查找，语言切换触发重渲染

---

### Task 1.5: 集成 I18nProvider 到应用 [P0]

**预估工时**: 0.5 小时 | **依赖**: Task 1.4

**任务清单**:
- [x] 修改 `src/main.tsx`，在根组件外层包裹 `I18nProvider`

**验收标准**: 应用正常启动，所有组件可使用 `useTranslation()`

---

## 第二阶段：翻译数据准备（3-4天）

### Task 2.1: 提取现有 UI 文本 [P1]

**预估工时**: 3 小时 | **依赖**: 无

**任务清单**:
- [x] 使用正则搜索提取所有中文文本（MainView、Settings、EditorToolbar、Sidebar 等）
- [x] 创建文本清单（组件、中文、翻译键、英文）

**验收标准**: 所有 UI 中文文本已提取，翻译键命名符合约定

---

### Task 2.2: 设计翻译数据结构 [P1]

**预估工时**: 2 小时 | **依赖**: Task 2.1

**任务清单**:
- [x] 设计命名空间（common、pages、components、sampleData、errors）
- [x] 在 `src/i18n/types.ts` 定义 `TranslationData` 接口

**验收标准**: 接口完整，命名空间合理，TypeScript 编译通过

---

### Task 2.3: 创建中文翻译文件 [P1]

**预估工时**: 3 小时 | **依赖**: Task 2.2

**任务清单**:
- [x] 创建 `src/i18n/locales/zh-CN.ts`
- [x] 填充所有中文翻译，包括示例数据

**验收标准**: 符合 `TranslationData` 接口，所有键有值，类型检查通过

---

### Task 2.4: 创建英文翻译文件 [P1]

**预估工时**: 4 小时 | **依赖**: Task 2.3

**任务清单**:
- [x] 创建 `src/i18n/locales/en-US.ts`
- [x] 翻译所有中文文本，包括示例数据

**验收标准**: 符合接口，翻译准确自然，类型检查通过

---

### Task 2.5: 创建翻译数据索引 [P1]

**预估工时**: 0.5 小时 | **依赖**: Task 2.4

**任务清单**:
- [x] 创建 `src/i18n/locales/index.ts`，导出 `translations` 对象
- [x] 更新 `I18nContext.tsx` 使用真实翻译数据

**验收标准**: 所有语言正确导出，Context 正确使用

---

## 第三阶段：UI 组件开发（2-3天）

### Task 3.1: 创建语言切换按钮组件 [P1]

**预估工时**: 2 小时 | **依赖**: Task 2.5

**任务清单**:
- [x] 创建 `src/components/common/LanguageSwitcher.tsx`
- [x] 实现按钮 UI（地球图标 + 语言名称）、悬停提示、键盘导航
- [x] 集成 i18nStore，调用 `toggleLocale()`
- [x] 编写组件测试

**验收标准**: 按钮显示正确，点击切换语言，支持键盘导航，符合 M3 规范

---

### Task 3.2: 集成语言切换按钮到主界面 [P1]

**预估工时**: 1 小时 | **依赖**: Task 3.1

**任务清单**:
- [x] 修改 `src/pages/MainView.tsx`，在 header 中添加 LanguageSwitcher（设置按钮左侧）

**验收标准**: 按钮位置正确，布局美观，响应式正常

---

### Task 3.3: 更新 MainView 组件使用翻译 [P1]

**预估工时**: 2 小时 | **依赖**: Task 3.2

**任务清单**:
- [x] 修改 `src/pages/MainView.tsx`，使用 `useTranslation()` 替换所有硬编码文本

**验收标准**: 所有文本正确翻译，中英文切换正常

---

### Task 3.4: 更新 Settings 组件使用翻译 [P1]

**预估工时**: 2 小时 | **依赖**: Task 2.5

**任务清单**:
- [x] 修改 `src/pages/Settings.tsx`，国际化所有设置项文本

**验收标准**: 所有设置项文本支持中英文

---

### Task 3.5: 更新 EditorToolbar 组件使用翻译 [P1]

**预估工时**: 1 小时 | **依赖**: Task 2.5

**任务清单**:
- [x] 修改 `src/components/editor/EditorToolbar.tsx`，国际化按钮文本

**验收标准**: 工具栏按钮文本支持中英文

---

### Task 3.6: 更新 Sidebar 组件使用翻译 [P1]

**预估工时**: 1.5 小时 | **依赖**: Task 2.5

**任务清单**:
- [x] 修改 `src/components/layout/Sidebar.tsx`，国际化侧边栏文本

**验收标准**: 侧边栏所有文本支持中英文

---

### Task 3.7: 更新其他组件使用翻译 [P2]

**预估工时**: 3 小时 | **依赖**: Task 2.5

**任务清单**:
- [x] 更新 VersionCanvas、VersionCard、CompareModal、AttachmentGallery 等组件

**验收标准**: 所有组件文本支持中英文

---

## 第四阶段：示例数据国际化（1天）

### Task 4.1: 更新示例数据服务 [P2]

**预估工时**: 2 小时 | **依赖**: Task 2.5

**任务清单**:
- [x] 修改 `src/services/initializeSampleData.ts`
- [x] 根据当前语言从翻译数据获取示例项目和版本文本

**验收标准**: 示例数据根据语言生成，用户数据不受影响

---

## 第五阶段：测试（2-3天）

### Task 5.1: 单元测试 [P1]

**预估工时**: 3 小时 | **依赖**: Task 1.2, 1.3

**任务清单**:
- [ ] 完善 `detectLanguage.test.ts` - 测试各种浏览器语言配置
- [ ] 完善 `i18nStore.test.ts` - 测试状态管理和持久化

**验收标准**: 单元测试覆盖率 > 90%，所有测试通过

---

### Task 5.2: 组件测试 [P1]

**预估工时**: 2 小时 | **依赖**: Task 3.1

**任务清单**:
- [ ] 创建 `LanguageSwitcher.test.tsx` - 测试按钮交互和语言切换

**验收标准**: 组件测试通过，覆盖主要交互场景

---

### Task 5.3: 浏览器 E2E 测试 [P1]

**预估工时**: 3 小时 | **依赖**: Task 3.7, 4.1

**任务清单**:
- [ ] 创建 `i18n-switching.e2e.ts`
- [ ] 使用 chrome-devtools-mcp 测试完整流程
  - [ ] 启动应用，验证默认语言
  - [ ] 点击语言切换按钮
  - [ ] 验证所有 UI 文本更新
  - [ ] 刷新页面，验证语言保持
  - [ ] 验证示例数据使用正确语言

**验收标准**: E2E 测试通过，覆盖完整用户流程

---

## 第六阶段：文档和收尾（1天）

### Task 6.1: 更新项目文档 [P2]

**预估工时**: 2 小时 | **依赖**: 所有功能完成

**任务清单**:
- [ ] 更新 README.md 说明 i18n 功能
- [ ] 添加贡献指南（如何添加新语言）
- [ ] 更新 docs/general_index.md

**验收标准**: 文档完整，易于理解

---

### Task 6.2: 代码审查和优化 [P2]

**预估工时**: 2 小时 | **依赖**: 所有功能完成

**任务清单**:
- [ ] 代码审查，确保符合项目规范
- [ ] 性能优化（如有必要）
- [ ] 清理临时代码和注释

**验收标准**: 代码质量高，无明显性能问题

---

## 总结

**总预估工时**: 约 40-50 小时（5-7 个工作日）

**关键里程碑**:
1. ✅ 第一阶段完成：基础设施可用
2. ✅ 第二阶段完成：翻译数据就绪
3. ✅ 第三阶段完成：UI 完全国际化
4. ✅ 第四阶段完成：示例数据国际化
5. ⏸️ 第五阶段：测试（待后续完善）
6. ⏸️ 第六阶段：文档和收尾（待后续完善）

**风险和缓解**:
- **风险**: 翻译质量不佳 → **缓解**: 审核翻译，必要时请专业人员
- **风险**: 遗漏部分 UI 文本 → **缓解**: 系统性检查，使用正则搜索
- **风险**: 性能问题 → **缓解**: 性能测试，优化翻译函数

**实施总结**:
- ✅ 所有核心功能已完成（阶段1-4）
- ✅ 编译通过，无 TypeScript 错误
- ✅ 语言切换功能正常工作
- ✅ LocalStorage 键已规范化到 STORAGE_KEYS
- ⏸️ 单元测试和 E2E 测试待后续完善
- ⏸️ 项目文档更新待后续完善

**完成日期**: 2025-11-24