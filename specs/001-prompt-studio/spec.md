# Feature Specification: Prompt Studio - AI 提示词版本管理与编辑工具

**Feature Branch**: `001-prompt-studio`  
**Created**: 2025-11-16  
**Status**: Draft  
**Input**: User description: "参考 PRD.md UI.md TECH.md，从零开始实现 prompt studio"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 版本创建与基础编辑 (Priority: P1)

Prompt 工程师需要创建项目，输入提示词内容，并保存第一个版本。他们希望能够快速开始工作，无需复杂的设置过程。

**Why this priority**: 这是应用的核心功能基础。没有版本创建和基本编辑，其他所有功能都无法使用。这是最小可用产品（MVP）的核心。

**Independent Test**: 用户能够创建一个新项目，在编辑器中输入提示词文本，保存为版本，刷新页面后数据仍然存在（IndexedDB 持久化验证）。

**Acceptance Scenarios**:

1. **Given** 用户打开应用首页，**When** 点击"创建项目"按钮并输入项目名称，**Then** 系统创建新项目并显示在左侧项目列表中
2. **Given** 用户选中一个项目，**When** 在右侧编辑器中输入提示词文本并按 Ctrl+Enter，**Then** 系统创建新版本节点并在画布中显示
3. **Given** 用户刚保存了一个版本，**When** 刷新浏览器页面，**Then** 项目和版本数据完整恢复，用户可继续编辑
4. **Given** 用户选中一个叶子节点版本，**When** 修改文本并按 Ctrl+Shift+Enter，**Then** 系统原地更新该版本内容而不创建新节点

---

### User Story 2 - 版本树可视化与导航 (Priority: P1)

Prompt 工程师创建了多个版本后，需要通过可视化的树状图查看版本演进历史，并快速定位和切换不同版本进行查看或编辑。

**Why this priority**: 可视化版本树是区别于普通文本编辑器的核心价值。它让用户能够理解版本之间的关系，这是 MVP 必须具备的功能。

**Independent Test**: 用户创建至少 3 个版本（包含分支），能够在画布中看到树状结构，点击任意节点后右侧编辑器显示对应内容。

**Acceptance Scenarios**:

1. **Given** 项目有 5 个版本形成树状结构，**When** 用户打开该项目，**Then** 画布自动定位到最新更新的版本节点
2. **Given** 版本树在画布中显示，**When** 用户点击任意版本节点，**Then** 节点高亮显示操作按钮，右侧编辑器加载该版本内容
3. **Given** 版本树超出屏幕范围，**When** 用户在画布空白区域拖动鼠标，**Then** 整个树结构平移，用户可查看屏幕外的节点
4. **Given** 用户在画布中，**When** 按住 Ctrl 并滚动鼠标滚轮，**Then** 画布缩放，用户可放大查看细节或缩小查看全局
5. **Given** 用户在缩放/平移后迷失位置，**When** 点击"重置视图"按钮，**Then** 画布恢复默认缩放和位置

---

### User Story 3 - 版本对比与差异查看 (Priority: P2)

Prompt 工程师需要对比两个版本的提示词差异，以了解哪些改动导致了不同的 AI 输出效果。

**Why this priority**: 版本对比是优化提示词的关键工具，但在有了基础版本管理后才有意义。它是提升工作效率的重要功能。

**Independent Test**: 用户选择树中任意两个版本，能够在并排视图中清晰看到文本的增加、删除和修改部分。

**Acceptance Scenarios**:

1. **Given** 用户在编辑器工具栏，**When** 点击"对比"按钮并选择另一个版本，**Then** 弹出全屏模态框显示并排 Diff 视图
2. **Given** Diff 视图显示中，**When** 查看对比结果，**Then** 增加的文本用绿色高亮，删除的文本用红色高亮，修改的文本清晰标注
3. **Given** 用户在 Diff 视图中，**When** 点击关闭按钮或按 Esc 键，**Then** 模态框关闭，返回正常编辑视图

---

### User Story 4 - 文件夹与项目组织 (Priority: P2)

Prompt 工程师管理多个项目时，需要通过文件夹对项目进行分类组织，提高查找效率。

**Why this priority**: 组织功能在单项目时不是必需的，但对于频繁使用的用户非常重要。它是可用性提升的功能。

**Independent Test**: 用户能够创建多层文件夹，将项目在不同文件夹间移动，展开/折叠文件夹结构。

**Acceptance Scenarios**:

1. **Given** 用户在左侧边栏，**When** 右键点击空白区域并选择"新建文件夹"，**Then** 创建新文件夹并进入编辑状态
2. **Given** 用户有多个文件夹和项目，**When** 拖动项目到目标文件夹，**Then** 项目移动到新位置
3. **Given** 用户在左侧边栏，**When** 点击文件夹的展开/折叠图标，**Then** 文件夹内容显示或隐藏
4. **Given** 用户右键点击项目，**When** 选择"重命名"或"删除"，**Then** 执行对应操作并更新左侧边栏

---

### User Story 5 - Prompt 片段库管理 (Priority: P3)

Prompt 工程师有常用的文本片段（如画风描述、角色设定），需要保存并快速插入到当前编辑位置。

**Why this priority**: 片段库是效率工具，属于锦上添花的功能。用户可以先通过复制粘贴实现类似效果。

**Independent Test**: 用户能够创建片段，为片段命名，在编辑器中点击按钮插入片段到光标位置。

**Acceptance Scenarios**:

1. **Given** 用户在编辑器中选中一段文本，**When** 点击"保存为片段"并输入名称，**Then** 片段保存到片段库
2. **Given** 用户在编辑器中，**When** 点击"片段库"按钮并选择一个片段，**Then** 片段内容插入到当前光标位置
3. **Given** 用户在片段库管理界面，**When** 编辑或删除片段，**Then** 变更立即生效并保存

---

### User Story 6 - 数据导入导出与备份 (Priority: P3)

Prompt 工程师需要备份数据防止丢失，或在不同设备间同步数据。

**Why this priority**: 数据安全很重要,但对于本地优先应用，浏览器 IndexedDB 已提供基础持久化。导入导出是额外的安全保障。

**Independent Test**: 用户能够导出项目为 ZIP 文件（包含附件），在另一台设备导入后完整恢复所有数据。

**Acceptance Scenarios**:

1. **Given** 用户在设置页面，**When** 选择"导出为 ZIP"并选择项目，**Then** 下载包含数据和附件的 ZIP 文件
2. **Given** 用户有导出的 ZIP 文件，**When** 在设置页面上传该文件，**Then** 系统解析并导入所有项目和版本数据
3. **Given** 用户配置了 WebDAV 服务器，**When** 点击"备份到 WebDAV"，**Then** 数据上传到远程服务器
4. **Given** 用户需要恢复数据，**When** 点击"从 WebDAV 还原"，**Then** 系统下载并恢复数据

---

### User Story 7 - 附件管理（图片/视频） (Priority: P4)

Prompt 工程师在处理图像生成或视频生成提示词时，需要为版本附加参考图片或生成结果视频。

**Why this priority**: 附件功能对特定用户场景（图像/视频生成）很有价值，但不是所有用户都需要。可延后实现。

**Independent Test**: 用户能够为版本上传图片附件，查看缩略图，点击预览大图，删除附件。

**Acceptance Scenarios**:

1. **Given** 用户在版本详情的附件区域，**When** 点击上传或拖拽图片文件，**Then** 图片保存并显示缩略图
2. **Given** 版本有附件，**When** 点击缩略图，**Then** 弹出模态框显示大图预览
3. **Given** 用户在附件缩略图上，**When** 点击删除按钮，**Then** 附件被移除

---

### Edge Cases

- **空项目场景**: 用户创建项目后未添加任何版本，打开项目时画布应显示提示信息引导创建第一个版本
- **单节点删除**: 当项目只有一个根节点版本时，删除该版本应清空画布但保留项目
- **深层嵌套**: 当版本树超过 20 层深度时，画布渲染性能如何保证？（假设：限制显示深度或虚拟滚动）
- **大文本处理**: 提示词文本超过 100,000 字符时，编辑器性能如何？（假设：采用 CodeMirror 的惰性渲染）
- **并发编辑**: 同一浏览器多个标签页同时编辑同一项目时，IndexedDB 数据冲突如何处理？（假设：最后写入胜出，可能提示用户刷新）
- **存储配额**: IndexedDB 存储空间不足时如何提示用户？（假设：监控配额并在接近限制时警告）
- **WebDAV 连接失败**: CORS 配置错误或网络问题导致 WebDAV 操作失败时，应显示清晰的错误信息和解决建议

## Requirements *(mandatory)*

### Functional Requirements

<!--
  原则对齐检查：
  - ✅ 所有需求符合"本地优先"原则（客户端逻辑，IndexedDB 存储）
  - ✅ UI 需求遵循 Material Design 3 规范
  - ✅ 数据模型保持扁平化结构（ID 引用关联）
  - ✅ 交互支持键盘导航和可访问性
-->

#### 项目与组织管理

- **FR-001**: 系统必须允许用户创建、重命名、删除文件夹，文件夹可嵌套形成树状结构
- **FR-002**: 系统必须允许用户在文件夹内创建项目，项目必须有名称和创建时间
- **FR-003**: 系统必须在项目内任何版本变化时自动更新项目的"更新时间"字段
- **FR-004**: 系统必须支持为项目添加标签（模型、平台、类型三个分类），标签为可选字段
- **FR-005**: 系统必须允许用户通过拖拽方式在文件夹间移动项目

#### 版本管理核心

- **FR-006**: 系统必须为每个版本生成全局唯一 ID
- **FR-007**: 系统必须通过 parentId 字段维护版本的父子关系，构成树状结构
- **FR-008**: 系统必须在创建版本时记录 createdAt 时间戳，在原地更新时记录 updatedAt 时间戳
- **FR-009**: 系统必须支持两种保存方式：创建新版本（Ctrl+Enter）和原地更新叶子节点（Ctrl+Shift+Enter）
- **FR-010**: 系统必须在删除中间节点时执行"接骨"逻辑，将子节点的 parentId 指向被删节点的父节点
- **FR-011**: 系统必须计算每个版本的 contentHash（基于 normalizedContent 的 SHA-256），用于重复版本提醒
- **FR-012**: 系统必须在创建新版本时检查是否存在相同 contentHash 的版本，如有则提示用户

#### 可视化画布

- **FR-013**: 系统必须在画布中以树状图展示版本，节点从上到下垂直排列，父子节点用连线连接
- **FR-014**: 系统必须在打开项目时自动定位到"更新时间"最新的版本节点
- **FR-015**: 系统必须支持画布平移：在空白区域拖动鼠标可移动整个视图
- **FR-016**: 系统必须支持画布缩放：Ctrl+滚轮（桌面）或双指捏合（触控）实现缩放
- **FR-017**: 系统必须提供"重置视图"按钮，一键恢复默认缩放和位置
- **FR-018**: 系统必须在点击版本节点时高亮该节点，展开操作按钮栏，并在右侧面板加载内容

#### 文本编辑器

- **FR-019**: 系统必须提供基于 CodeMirror 6 的文本编辑器
- **FR-020**: 系统必须支持编辑器内文本搜索，包括多行文本和正则表达式搜索
- **FR-021**: 系统必须实现智能选择：拖拽选择时以词/字为单元"吸附"选中
- **FR-022**: 系统必须在编辑器工具栏提供"保存"、"原地保存"、"片段库"、"版本对比"按钮

#### 版本对比

- **FR-023**: 系统必须支持选择任意两个版本进行对比
- **FR-024**: 系统必须以全屏模态框展示并排 Diff 视图
- **FR-025**: 系统必须高亮显示增加（绿色）、删除（红色）和修改的文本

#### 片段库

- **FR-026**: 系统必须允许用户创建、命名、编辑、删除 Prompt 片段
- **FR-027**: 系统必须支持将片段插入到编辑器当前光标位置

#### 数据持久化

- **FR-028**: 系统必须使用 IndexedDB 存储所有项目、版本和附件数据
- **FR-029**: 系统必须以扁平化数组形式存储数据，通过 ID 引用关联（不使用嵌套结构）
- **FR-030**: 系统必须在内存中根据 parentId 动态构建树状结构用于渲染

#### 导入导出

- **FR-031**: 系统必须支持导出项目为 JSON 格式（纯文本，不含附件）
- **FR-032**: 系统必须支持导出项目为 ZIP 格式（包含 data.json 和附件文件）
- **FR-033**: 系统必须支持导入符合格式的 JSON 或 ZIP 文件
- **FR-034**: 系统必须支持配置 WebDAV 服务器（地址、认证信息）
- **FR-035**: 系统必须支持备份到 WebDAV 和从 WebDAV 还原数据

#### 附件管理

- **FR-036**: 系统必须允许用户为版本上传图片或视频附件
- **FR-037**: 系统必须将附件作为 Blob 存储在 IndexedDB 中
- **FR-038**: 系统必须显示附件缩略图，支持点击预览和删除

#### UI/UX 规范

- **FR-039**: 系统必须遵循 Material Design 3 规范，使用种子色 rgb(207, 235, 131) 生成色彩方案
- **FR-040**: 系统必须确保色彩对比度符合 WCAG 2.1 AA 标准
- **FR-041**: 系统必须支持响应式布局：桌面（> 1024px）三栏，平板（640-1024px）可折叠侧边栏，移动（< 640px）单页视图切换
- **FR-042**: 系统必须为所有图标按钮提供 aria-label，支持屏幕阅读器
- **FR-043**: 系统必须支持完整的键盘导航（Tab, Enter, Space, Arrow Keys）

#### 性能与约束

- **FR-044**: 系统必须在版本树超过 100 个节点时保持流畅的画布操作（假设目标：60fps 交互）
- **FR-045**: 系统必须处理单个版本文本长度达 50,000 字符的编辑场景

### Key Entities

- **Folder（文件夹）**: 组织项目的容器，属性包括 id、name、parentId（支持嵌套）、createdAt
- **Project（项目）**: 管理一组相关版本的顶层容器，属性包括 id、folderId、name、createdAt、updatedAt、tags（可选，包含 model/platform/type 分类）
- **Version（版本）**: 提示词的单个版本，属性包括 id、parentId、projectId、createdAt、updatedAt、content（原始文本）、normalizedContent（标准化文本）、contentHash（SHA-256）、score（可选评分）、attachments（附件数组）
- **Snippet（片段）**: 可复用的文本片段，属性包括 id、name、content、createdAt
- **Attachment（附件）**: 图片或视频文件，属性包括 id、versionId、fileName、fileType、blob（二进制数据）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户能够在 30 秒内完成项目创建并保存第一个版本
- **SC-002**: 用户在版本树中点击任意节点后，右侧编辑器内容加载时间不超过 200 毫秒
- **SC-003**: 画布支持至少 200 个版本节点的流畅展示和交互，缩放/平移操作无明显卡顿
- **SC-004**: 用户能够在 3 次点击内完成版本对比操作（选择节点 → 点击对比 → 选择第二个版本）
- **SC-005**: 数据刷新浏览器后 100% 恢复，无数据丢失
- **SC-006**: 导出和导入一个包含 50 个版本和 10 个附件的项目，整个流程在 10 秒内完成
- **SC-007**: 所有核心操作（创建、编辑、删除、对比）支持键盘快捷键，用户无需依赖鼠标
- **SC-008**: 应用在离线状态下所有本地功能（版本管理、编辑、导出）正常工作
- **SC-009**: 首次加载应用到显示可交互界面的时间不超过 2 秒（假设正常网络环境）
- **SC-010**: 用户对版本可视化树的理解度达到 90%（通过可用性测试：能够正确识别父子关系和分支）
